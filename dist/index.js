(()=>{class e extends Error{response;request;options;constructor(e,t,s){const n=`${e.status||0===e.status?e.status:""} ${e.statusText||""}`.trim();super(`Request failed with ${n?`status code ${n}`:"an unknown error"}: ${t.method} ${t.url}`),this.name="HTTPError",this.response=e,this.request=t,this.options=s}}class t extends Error{request;constructor(e){super(`Request timed out: ${e.method} ${e.url}`),this.name="TimeoutError",this.request=e}}const s=e=>null!==e&&"object"==typeof e,n=(...e)=>{for(const t of e)if((!s(t)||Array.isArray(t))&&void 0!==t)throw new TypeError("The `options` argument must be an object");return i({},...e)},o=(e={},t={})=>{const s=new globalThis.Headers(e),n=t instanceof globalThis.Headers,o=new globalThis.Headers(t);for(const[e,t]of o.entries())n&&"undefined"===t||void 0===t?s.delete(e):s.set(e,t);return s};function a(e,t,s){return Object.hasOwn(t,s)&&void 0===t[s]?[]:i(e[s]??[],t[s]??[])}const r=(e={},t={})=>({beforeRequest:a(e,t,"beforeRequest"),beforeRetry:a(e,t,"beforeRetry"),afterResponse:a(e,t,"afterResponse"),beforeError:a(e,t,"beforeError")}),i=(...e)=>{let t={},n={},a={};for(const l of e)if(Array.isArray(l))Array.isArray(t)||(t=[]),t=[...t,...l];else if(s(l)){for(let[e,n]of Object.entries(l))s(n)&&e in t&&(n=i(t[e],n)),t={...t,[e]:n};s(l.hooks)&&(a=r(a,l.hooks),t.hooks=a),s(l.headers)&&(n=o(n,l.headers),t.headers=n)}return t},l=(()=>{let e=!1,t=!1;const s="function"==typeof globalThis.ReadableStream,n="function"==typeof globalThis.Request;if(s&&n)try{t=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type")}catch(e){if(e instanceof Error&&"unsupported BodyInit type"===e.message)return!1;throw e}return e&&!t})(),c="function"==typeof globalThis.AbortController,p="function"==typeof globalThis.ReadableStream,u="function"==typeof globalThis.FormData,h=["get","post","put","patch","head","delete"],d={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},f=2147483647,m=Symbol("stop"),y={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,fetch:!0},g={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},w=e=>h.includes(e)?e.toUpperCase():e,b={limit:2,methods:["get","put","head","delete","options","trace"],statusCodes:[408,413,429,500,502,503,504],afterStatusCodes:[413,429,503],maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:e=>.3*2**(e-1)*1e3},I=(e={})=>{if("number"==typeof e)return{...b,limit:e};if(e.methods&&!Array.isArray(e.methods))throw new Error("retry.methods must be an array");if(e.statusCodes&&!Array.isArray(e.statusCodes))throw new Error("retry.statusCodes must be an array");return{...b,...e}};async function _(e,s,n,o){return new Promise(((a,r)=>{const i=setTimeout((()=>{n&&n.abort(),r(new t(e))}),o.timeout);o.fetch(e,s).then(a).catch(r).then((()=>{clearTimeout(i)}))}))}async function P(e,{signal:t}){return new Promise(((s,n)=>{function o(){clearTimeout(a),n(t.reason)}t&&(t.throwIfAborted(),t.addEventListener("abort",o,{once:!0}));const a=setTimeout((()=>{t?.removeEventListener("abort",o),s()}),e)}))}const v=(e,t)=>{const s={};for(const n in t)n in g||n in y||n in e||(s[n]=t[n]);return s};class k{static create(t,s){const n=new k(t,s),o=async()=>{if("number"==typeof n._options.timeout&&n._options.timeout>f)throw new RangeError("The `timeout` option cannot be greater than 2147483647");await Promise.resolve();let t=await n._fetch();for(const e of n._options.hooks.afterResponse){const s=await e(n.request,n._options,n._decorateResponse(t.clone()));s instanceof globalThis.Response&&(t=s)}if(n._decorateResponse(t),!t.ok&&n._options.throwHttpErrors){let s=new e(t,n.request,n._options);for(const e of n._options.hooks.beforeError)s=await e(s);throw s}if(n._options.onDownloadProgress){if("function"!=typeof n._options.onDownloadProgress)throw new TypeError("The `onDownloadProgress` option must be a function");if(!p)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return n._stream(t.clone(),n._options.onDownloadProgress)}return t},a=n._options.retry.methods.includes(n.request.method.toLowerCase())?n._retry(o):o();for(const[e,t]of Object.entries(d))a[e]=async()=>{n.request.headers.set("accept",n.request.headers.get("accept")||t);const o=await a;if("json"===e){if(204===o.status)return"";if(0===(await o.clone().arrayBuffer()).byteLength)return"";if(s.parseJson)return s.parseJson(await o.text())}return o[e]()};return a}request;abortController;_retryCount=0;_input;_options;constructor(e,t={}){if(this._input=e,this._options={...t,headers:o(this._input.headers,t.headers),hooks:r({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},t.hooks),method:w(t.method??this._input.method??"GET"),prefixUrl:String(t.prefixUrl||""),retry:I(t.retry),throwHttpErrors:!1!==t.throwHttpErrors,timeout:t.timeout??1e4,fetch:t.fetch??globalThis.fetch.bind(globalThis)},"string"!=typeof this._input&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&"string"==typeof this._input){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(c){this.abortController=new globalThis.AbortController;const e=this._options.signal??this._input.signal;e?.aborted&&this.abortController.abort(e?.reason),e?.addEventListener("abort",(()=>{this.abortController.abort(e.reason)})),this._options.signal=this.abortController.signal}if(l&&(this._options.duplex="half"),void 0!==this._options.json&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const e="?"+("string"==typeof this._options.searchParams?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),t=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,e);!(u&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)||this._options.headers&&this._options.headers["content-type"]||this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(t,{...this.request}),this._options)}}_calculateRetryDelay(s){if(this._retryCount++,this._retryCount>this._options.retry.limit||s instanceof t)throw s;if(s instanceof e){if(!this._options.retry.statusCodes.includes(s.response.status))throw s;const e=s.response.headers.get("Retry-After")??s.response.headers.get("RateLimit-Reset")??s.response.headers.get("X-RateLimit-Reset")??s.response.headers.get("X-Rate-Limit-Reset");if(e&&this._options.retry.afterStatusCodes.includes(s.response.status)){let t=1e3*Number(e);Number.isNaN(t)?t=Date.parse(e)-Date.now():t>=Date.parse("2024-01-01")&&(t-=Date.now());const s=this._options.retry.maxRetryAfter??t;return t<s?t:s}if(413===s.response.status)throw s}const n=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,n)}_decorateResponse(e){return this._options.parseJson&&(e.json=async()=>this._options.parseJson(await e.text())),e}async _retry(e){try{return await e()}catch(t){const s=Math.min(this._calculateRetryDelay(t),f);if(this._retryCount<1)throw t;await P(s,{signal:this._options.signal});for(const e of this._options.hooks.beforeRetry){if(await e({request:this.request,options:this._options,error:t,retryCount:this._retryCount})===m)return}return this._retry(e)}}async _fetch(){for(const e of this._options.hooks.beforeRequest){const t=await e(this.request,this._options);if(t instanceof Request){this.request=t;break}if(t instanceof Response)return t}const e=v(this.request,this._options),t=this.request;return this.request=t.clone(),!1===this._options.timeout?this._options.fetch(t,e):_(t,e,this.abortController,this._options)}_stream(e,t){const s=Number(e.headers.get("content-length"))||0;let n=0;return 204===e.status?(t&&t({percent:1,totalBytes:s,transferredBytes:n},new Uint8Array),new globalThis.Response(null,{status:e.status,statusText:e.statusText,headers:e.headers})):new globalThis.Response(new globalThis.ReadableStream({async start(o){const a=e.body.getReader();t&&t({percent:0,transferredBytes:0,totalBytes:s},new Uint8Array),await async function e(){const{done:r,value:i}=await a.read();if(r)o.close();else{if(t){n+=i.byteLength;t({percent:0===s?0:n/s,transferredBytes:n,totalBytes:s},i)}o.enqueue(i),await e()}}()}}),{status:e.status,statusText:e.statusText,headers:e.headers})}}const T=e=>{const t=(t,s)=>k.create(t,n(e,s));for(const s of h)t[s]=(t,o)=>k.create(t,n(e,o,{method:s}));return t.create=e=>T(n(e)),t.extend=t=>("function"==typeof t&&(t=t(e??{})),T(n(e,t))),t.stop=m,t};var R=T();const S={get length(){try{return localStorage.length}catch{return 0}},clear:function(){try{localStorage.clear()}catch{}},getItem:function(e){try{return localStorage.getItem(e)}catch{return null}},removeItem:function(e){try{localStorage.removeItem(e)}catch{}},setItem:function(e,t){try{localStorage.setItem(e,t)}catch{}},key:function(e){try{return localStorage.key(e)}catch{return null}}};let x;var q;(q=x||(x={})).Instances="instances",q.CurrentInstance="current-instance";const C=e=>`https://www.youtube.com/playlist?list=${e}`,U=async()=>{const e=await R.get("https://piped-instances.kavin.rocks/").json();return S.setItem(x.Instances,JSON.stringify(e)),e},$=async()=>{const e=S.getItem(x.Instances);let t=[];t=e?JSON.parse(e):await U();const s=t[Math.floor(Math.random()*t.length)].api_url;return S.setItem(x.CurrentInstance,s),s},j=async()=>{const e=S.getItem(x.Instances);return e?JSON.parse(e):await U()},D=async()=>{let e=S.getItem(x.CurrentInstance);return e||(e=await $()),e};async function A(e,t=0){const s=await j();let n=await D();t>0&&t<s.length&&(n=s[t].api_url);try{const t=`${n}/streams/${e}`,s=1e4,o=new Promise(((e,t)=>{setTimeout((()=>t()),s)})),a=R.get(t).json();await Promise.race([a,o]);const r=await a;return{title:r.title,apiId:e,sources:[{source:r.hls,type:"application/x-mpegURL"}],duration:r.duration,views:r.views,likes:r.likes,dislikes:r.dislikes,description:r.description,channelName:r.uploader,channelApiId:r.uploaderUrl.split("/").slice(-1)[0],uploadDate:new Date(r.uploadDate).toISOString(),recommendedVideos:r.relatedStreams.map((e=>({title:e.title,apiId:e.url.split("=").slice(-1)[0],images:[{url:e.thumbnail}],duration:e.duration,views:e.views,channelName:e.uploaderName,channelApiId:e.uploaderUrl?.split("/").slice(-1)[0]})))}}catch(s){if(t<(await j()).length)return A(e,t+1);throw s}}const E=async e=>{const t=`${await D()}/comments/${e.apiId}`,s=await R.get(t).json();return{comments:s.comments.map((t=>({apiId:t.commentId,videoCommentId:e.apiId,content:t.commentText,author:t.author,images:[{url:t.thumbnail}],likes:t.likeCount}))),pageInfo:{resultsPerPage:0,offset:0,nextPage:s.nextpage}}},N=async e=>{const t=`${await D()}/search?q=${e.query}&filter=video`,s=await R.get(t).json();return{items:s.items.filter((e=>"stream"===e.type)).map((e=>({title:e.title,apiId:e.url.split("=").slice(-1)[0],images:[{url:e.thumbnail}],duration:e.duration,views:e.views,channelName:e.uploaderName,channelApiId:e.uploaderUrl?.split("/").slice(-1)[0]}))),pageInfo:{resultsPerPage:0,offset:0,nextPage:s.nextpage}}},L=async e=>{const t=`${await D()}/search?q=${e.query}&filter=playlist`,s=await R.get(t).json();return{items:s.items.filter((e=>"playlist"===e.type)).map((e=>({name:e.name,apiId:e.url.split("=").slice(-1)[0],images:[{url:e.thumbnail}],videos:[]}))),pageInfo:{resultsPerPage:0,offset:0,nextPage:s.nextpage}}},O=async e=>{const t=`${await D()}/search?q=${e.query}&filter=channel`,s=await R.get(t).json();return{items:s.items.filter((e=>"channel"===e.type)).map((e=>({name:e.name,apiId:e.url.split("=").slice(-1)[0],images:[{url:e.thumbnail}]}))),pageInfo:{resultsPerPage:0,offset:0,nextPage:s.nextpage}}},M=async e=>{const t=`${await D()}/channel/${e.apiId}/videos`,s=await R.get(t).json();return{items:s.relatedStreams.map((e=>({title:e.title,apiId:e.url.split("=").slice(-1)[0],images:[{url:e.thumbnail}],duration:e.duration,views:e.views,channelName:e.uploaderName,channelApiId:e.uploaderUrl?.split("/").slice(-1)[0]}))),pageInfo:{resultsPerPage:0,offset:0,nextPage:s.nextpage}}},B=async e=>{const t=`${await D()}/playlist/${e.apiId}/videos`,s=await R.get(t).json();return{items:s.relatedStreams.map((e=>({title:e.title,apiId:e.url.split("=").slice(-1)[0],images:[{url:e.thumbnail}],duration:e.duration,views:e.views,channelName:e.uploaderName,channelApiId:e.uploaderUrl?.split("/").slice(-1)[0]}))),pageInfo:{resultsPerPage:0,offset:0,nextPage:s.nextpage}}};var H={};Object.defineProperty(H,"__esModule",{value:!0});var J=["weeks","years","months","days","hours","minutes","seconds"],V=Object.freeze({years:0,months:0,weeks:0,days:0,hours:0,minutes:0,seconds:0}),G=H.pattern=new RegExp("P(?:(\\d+(?:[\\.,]\\d+)?W)|(\\d+(?:[\\.,]\\d+)?Y)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?D)?(?:T(\\d+(?:[\\.,]\\d+)?H)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?S)?)?)"),F=H.parse=function(e){return e.match(G).slice(1).reduce((function(e,t,s){return e[J[s]]=parseFloat(t)||0,e}),{})},z=H.end=function(e,t){e=Object.assign({},V,e);var s=t?t.getTime():Date.now(),n=new Date(s);return n.setFullYear(n.getFullYear()+e.years),n.setMonth(n.getMonth()+e.months),n.setDate(n.getDate()+e.days),n.setHours(n.getHours()+e.hours),n.setMinutes(n.getMinutes()+e.minutes),n.setMilliseconds(n.getMilliseconds()+1e3*e.seconds),n.setDate(n.getDate()+7*e.weeks),n},K=H.toSeconds=function(e,t){e=Object.assign({},V,e);var s=t?t.getTime():Date.now(),n=new Date(s);return(z(e,n).getTime()-n.getTime())/1e3};H.default={end:z,toSeconds:K,pattern:G,parse:F};const W="AIzaSyCCwk2lWH7eyv_48Jimp3hBFhR7CFZkWhM",Y=R.create({hooks:{beforeRequest:[e=>{const t=S.getItem("access_token");t&&e.headers.set("Authorization",`Bearer ${t}`)}],afterResponse:[async(e,t,s)=>{if(401===s.status){const s=await X();return e.headers.set("Authorization",`Bearer ${s}`),Y(e,t)}}]}}),Z=(e,t)=>{S.setItem("access_token",e),t&&S.setItem("refresh_token",t)},X=async()=>{const e=S.getItem("refresh_token");if(!e)return;const t=S.getItem("clientId"),s=S.getItem("clientSecret"),n=new URLSearchParams;n.append("refresh_token",e),n.append("grant_type","refresh_token"),t&&s&&(n.append("client_id",t),n.append("client_secret",s));const o=await R.post("https://oauth2.googleapis.com/token",{body:n,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).json();return o.access_token?(Z(o.access_token),o.access_token):void 0},Q=()=>S.getItem("apiKey");function ee(e){return(e.items||[]).map((e=>({apiId:e.id,name:e.snippet?.title||"",images:[{width:e.snippet?.thumbnails?.default?.width||0,url:e.snippet?.thumbnails?.default?.url||"",height:e.snippet?.thumbnails?.default?.height||0}],isUserPlaylist:!0,originalUrl:C(e.id||"")})))}function te(e){return(e.items||[]).map((e=>{return{apiId:e.id,duration:(0,H.toSeconds)((0,H.parse)(e.contentDetails?.duration||"0")),images:e.snippet?.thumbnails&&Object.values(e.snippet?.thumbnails).map((e=>({url:e.url||"",height:e.height||0,width:e.width||0}))),title:e.snippet?.title||"",originalUrl:(t=e.id||"",`https://www.youtube.com/watch?v=${t}`)};var t}))}async function se(){const e=`https://www.googleapis.com/youtube/v3/videos?key=${Q()||W}&chart=mostPopular&part=snippet,contentDetails`;return{videos:{items:te(await R.get(e).json())}}}async function ne(e){const t=e.join(","),s=`https://www.googleapis.com/youtube/v3/videos?key=${Q()||W}&part=snippet,contentDetails&id=${t}`;return te(await R.get(s).json())}async function oe(e){let t=`https://www.googleapis.com/youtube/v3/playlistItems?part=contentDetails&maxResults=50&key=${Q()}&playlistId=${e.apiId}`;e.isUserPlaylist&&(t+="&mine=true"),e.pageInfo&&(e.pageInfo.nextPage?t+=`&pageToken=${e.pageInfo.nextPage}`:e.pageInfo.prevPage&&(t+=`&pageToken=${e.pageInfo.prevPage}`));const s=e.isUserPlaylist?Y:R,n=await s.get(t).json(),o=n.items?.map((e=>e.contentDetails?.videoId)).filter((e=>!!e))||[];return{items:await ne(o),pageInfo:{totalResults:n.pageInfo?.totalResults||0,resultsPerPage:n.pageInfo?.resultsPerPage||0,offset:e.pageInfo?e.pageInfo.offset:0,nextPage:n.nextPageToken,prevPage:n.prevPageToken}}}async function ae(e){const t=`https://www.googleapis.com/youtube/v3/playlists?part=snippet,contentDetails&mine=true&key=${Q()}`,s=await Y.get(t).json();return{items:ee(s),pageInfo:{totalResults:s.pageInfo?.totalResults||0,resultsPerPage:s.pageInfo?.resultsPerPage||0,offset:e.pageInfo?e.pageInfo.offset:0,nextPage:s.nextPageToken,prevPage:s.prevPageToken}}}const re=e=>{application.postUiMessage(e)},ie=async()=>{const e=S.getItem("usePlayer");return!e||"true"===e},le=async e=>{const t=[];e.forEach((e=>{try{const s=/^(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu.be)\/(?:watch\?v=|embed\/|v\/)?([a-zA-Z0-9_-]+)(?:\S+)?$/,n=e.match(s);n&&t.push(n[1])}catch{}}));const s=t.length;let n=0,o=50;const a=[];for(;n<s;){const e=t.slice(n,o),s=await ne(e);a.push(...s),n+=50,o+=50}return a};async function ce(e){return N(e)}async function pe(e){return O(e)}async function ue(e){return L(e)}async function he(e){return e.isUserPlaylist?oe(e):B(e)}application.onUiMessage=async e=>{switch(e.type){case"check-login":const t=S.getItem("access_token");t&&re({type:"login",accessToken:t}),await(async()=>{const e=document.location.host.split(".");e.shift();const t=e.join("."),s=`${document.location.protocol}//${t}`,n=await application.getPluginId(),o=await application.getLocale(),a=await application.getPlaylistsInfo(),r=S.getItem("apiKey")??"",i=S.getItem("clientId")??"",l=S.getItem("clientSecret")??"",c=await ie(),p=await D();re({type:"info",origin:s,pluginId:n,apiKey:r,clientId:i,clientSecret:l,usePlayer:c,instance:p,locale:o,playlists:a})})();break;case"login":Z(e.accessToken,e.refreshToken),application.onGetUserPlaylists=ae;break;case"logout":S.removeItem("access_token"),S.removeItem("refresh_token"),application.onGetUserPlaylists=void 0;break;case"set-keys":S.setItem("apiKey",e.apiKey),S.setItem("clientId",e.clientId),S.setItem("clientSecret",e.clientSecret),application.createNotification({message:"Api Keys saved!"});break;case"useplayer":S.setItem("usePlayer",String(e.usePlayer));break;case"endvideo":application.endVideo();break;case"getinstnace":const s=await $();re({type:"sendinstance",instance:s});break;case"resolve-urls":const n=await le(e.videoUrls.split("\n"));await application.addVideosToPlaylist(e.playlistId,n),application.createNotification({message:"Success!"});break;default:}},application.onSearchAll=async function(e){const t=ce(e),s=ue(e),n=pe(e),[o,a,r]=await Promise.all([t,s,n]);return{videos:o,playlists:a,channels:r}},application.onSearchVideos=ce,application.onSearchPlaylists=ue,application.onSearchChannels=pe,application.onGetChannelVideos=async function(e){return M(e)},application.onGetPlaylistVideos=he,application.onGetVideoComments=async function(e){return E(e)},application.onGetCommentReplies=async function(e){const t={apiId:e.videoApiId,pageInfo:e.pageInfo};return E(t)},application.onGetTopItems=async function(){return await se()},application.onUsePlayer=ie,application.onGetVideo=async function(e){return A(e.apiId)},application.onLookupPlaylistUrl=async e=>{const t=new URL(e).searchParams.get("list");if(t){const e=await he({apiId:t,isUserPlaylist:!1});return{...e.playlist,videos:e.items}}throw new Error("Couldn't retreive playlist")},application.onLookupVideoUrls=le,application.onCanParseUrl=async function(e,t){if(!/^.*(youtu.be\/|list=)([^#\&\?]*).*/.test(e)&&!/^(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu.be)\/(?:watch\?v=|embed\/|v\/)?([a-zA-Z0-9_-]+)(?:\S+)?$/.test(e))return!1;switch(t){case"playlist":return new URL(e).searchParams.has("list");case"video":return!0;default:return!1}};const de=e=>{localStorage.setItem("kb-color-mode",e)};application.onChangeTheme=async e=>{de(e)};(async()=>{const e=await application.getTheme();de(e);S.getItem("access_token")&&(application.onGetUserPlaylists=ae)})()})();